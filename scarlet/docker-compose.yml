# ABIOGENESIS - Scarlet Environment Setup
# Modulo 1: Foundation con Letta
#
# RULES:
# - Usa bind mounts per sviluppo (veloce, nessun build)
# - Image gia' presente (letta/letta:patched) per evitare pull
# - Solo postgres+redis necessari (Ollama esterno se serve)
# - Build solo per produzione finale

services:
  letta-server:
    # Immagine Letta originale
    image: letta/letta:latest
    container_name: abiogenesis-letta
    ports:
      - "8283:8283"
    environment:
      # MiniMax API key per provider nativo
      - MINIMAX_API_KEY=${MINIMAX_API_KEY}
      # Usa PostgreSQL esterno invece del database interno
      - LETTA_PG_HOST=postgres
      - LETTA_PG_PASSWORD=${POSTGRES_PASSWORD:-scarlet_secure_password}
      # Usa Redis esterno invece del cache interno
      - LETTA_REDIS_HOST=redis
      # Ollama per embeddings (BGE-m3 su GPU)
      - OLLAMA_BASE_URL=http://ollama:11434
      # ====================================================================
      # SLEEP-TIME CONFIGURATION
      # ====================================================================
      # Disable native buggy sleep-time, use custom webhook instead
      - LETTA_SLEEPTIME_ENABLED=false
      # Webhook per step completion (custom sleep-time)
      - STEP_COMPLETE_WEBHOOK=http://sleep-webhook:8284/webhooks/step-complete
      # Optional: Authentication key for webhook (must match sleep-webhook)
      - STEP_COMPLETE_KEY=${STEP_COMPLETE_KEY:-}
    volumes:
      - ./data:/app/data:rw
      - ./prompts:/app/prompts:ro
      - ./.env:/app/.env:ro
      # NOTE: mount MiniMax fix rimossi - file non presenti nel fork locale
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      ollama:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - abiogenesis-net
    # Logging configurato per sviluppo
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  postgres:
    image: postgres:15-alpine
    container_name: abiogenesis-postgres
    environment:
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-scarlet_secure_password}
      - POSTGRES_DB=letta
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: unless-stopped
    networks:
      - abiogenesis-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: abiogenesis-redis
    restart: unless-stopped
    networks:
      - abiogenesis-net
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  ollama:
    image: ollama/ollama:latest
    container_name: abiogenesis-ollama
    ports:
      - "11434:11434"
    environment:
      - OLLAMA_GPU_ENABLED=true
      # Performance optimizations
      - OLLAMA_KEEP_ALIVE=-1              # Keep model always loaded (no unload)
      - OLLAMA_NUM_PARALLEL=4             # Allow 4 parallel requests
      - OLLAMA_FLASH_ATTENTION=true       # Enable flash attention for faster inference
      - OLLAMA_MAX_LOADED_MODELS=2        # Allow 2 models loaded simultaneously
    volumes:
      - ollama_data:/root/.ollama
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    networks:
      - abiogenesis-net
    healthcheck:
      test: ["CMD-SHELL", "ollama list || exit 1"]
      interval: 30s
      timeout: 30s
      retries: 5
      start_period: 60s
    restart: unless-stopped

  # ====================================================================
  # QDRANT - Vector Database per Long-Term Memory
  # ====================================================================
  # Store: episodic, semantic, procedural, emotional memories
  # Features: vector similarity search, hybrid search, quantization
  qdrant:
    image: qdrant/qdrant:v1.16.0
    container_name: abiogenesis-qdrant
    ports:
      - "6333:6333"  # REST API
      - "6334:6334"  # gRPC API
    volumes:
      - qdrant_data:/qdrant/storage
    environment:
      # API Configuration
      - QDRANT__SERVICE__API_TIMEOUT=30
      - QDRANT__SERVICE__HTTP_PORT=6333
      - QDRANT__SERVICE__GRPC_PORT=6334
      # Storage Configuration
      - QDRANT__STORAGE__OPTIMIZE_THRESHOLD=1024
      - QDRANT__STORAGE__PERFORMANCE_UPDATE_RATE=20
      - QDRANT__STORAGE__SEARCH_MAX_THREADS=4
      # Logging
      - QDRANT__LOG_LEVEL=INFO
    deploy:
      resources:
        reservations:
          memory: 2G
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6333/dashboard"]
      interval: 30s
      timeout: 10s
      retries: 5
    restart: unless-stopped
    networks:
      - abiogenesis-net

  # ====================================================================
  # SLEEP-WEBHOOK - Sleep-Time Consolidation Service
  # ====================================================================
  # Receives webhook calls from Letta after each step completion
  # Triggers sleep agent consolidation after N messages (default: 5)
  #
  # Architecture:
  # 1. Letta calls webhook after each step (STEP_COMPLETE_WEBHOOK)
  # 2. This service counts messages per conversation
  # 3. After threshold, triggers sleep agent consolidation
  # 4. Sleep agent analyzes and stores memories to Qdrant
  #
  # Configuration:
  # - LETTA_URL: Letta server URL
  # - SLEEP_THRESHOLD: Messages before consolidation (default: 5)
  # - STEP_COMPLETE_WEBHOOK: http://sleep-webhook:8284/webhooks/step-complete
  sleep-webhook:
    build:
      context: .
      dockerfile: Dockerfile.webhook
    container_name: abiogenesis-sleep-webhook
    ports:
      - "8284:8284"
    environment:
      - LETTA_URL=http://letta-server:8283
      - SLEEP_THRESHOLD=5
      - SLEEP_WEBHOOK_PORT=8284
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
    volumes:
      - ./src/sleep_webhook.py:/app/sleep_webhook.py:ro
      - ./src/memory:/app/memory:ro
      - ./.env:/app/.env:ro
    depends_on:
      letta-server:
        condition: service_started
    restart: unless-stopped
    networks:
      - abiogenesis-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8284/health"]
      interval: 30s
      timeout: 5s
      retries: 3

# Volumes solo per dati persistenti (non per codice)
volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  ollama_data:
    driver: local
  qdrant_data:
    driver: local

networks:
  abiogenesis-net:
    driver: bridge
    name: abiogenesis-network
